From b47e39cb67c1bd48868d02e1c1aa4d1fad8abc18 Mon Sep 17 00:00:00 2001
From: Anton Kikin <a.kikin@tano-systems.com>
Date: Thu, 15 Nov 2018 16:23:23 +0300
Subject: [PATCH] block: Fix some memory leaks and unnecessary duplicate mounts

Signed-off-by: Anton Kikin <a.kikin@tano-systems.com>
---
 block.c | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/block.c b/block.c
index 27c23e8..5e73c3f 100644
--- a/block.c
+++ b/block.c
@@ -1017,7 +1017,22 @@ static int mount_device(struct probe_info *pr, int type)
 
 	m = find_block(pr->uuid, pr->label, device, NULL);
 	if (m && m->extroot)
+	{
+		if (mp)
+			free(mp);
 		return -1;
+	}
+
+	if (m && mp && (strcmp(mp, m->target) == 0))
+	{
+		ULOG_INFO("%s is already mounted on requested target %s\n", pr->dev, m->target);
+		free(mp);
+		return 0;
+	}
+
+	/* mp is no longer used */
+	if (mp)
+		free(mp);
 
 	if (m) switch (type) {
 	case TYPE_HOTPLUG:
@@ -1107,7 +1122,10 @@ static int umount_device(struct probe_info *pr)
 
 	m = find_block(pr->uuid, pr->label, device, NULL);
 	if (m && m->extroot)
+	{
+		free(mp);
 		return -1;
+	}
 
 	err = umount2(mp, MNT_DETACH);
 	if (err)
-- 
2.16.2.windows.1

